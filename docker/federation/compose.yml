services:
  gateway:
    image: caddy:2.8
    restart: unless-stopped
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
    networks:
      federation:
        aliases:
          - egregoros.test
          - pleroma.test
          - mastodon.test

  egregoros_db:
    image: postgres:16
    restart: unless-stopped
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: egregoros_prod
    volumes:
      - egregoros_fed_db:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 10
    networks:
      - federation

  egregoros_web:
    build:
      context: ../..
    image: egregoros-fedbox
    restart: unless-stopped
    depends_on:
      egregoros_db:
        condition: service_healthy
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "bin/egregoros eval \"System.halt(if Egregoros.Release.healthcheck() == :ok, do: 0, else: 1)\""
        ]
      interval: 15s
      timeout: 10s
      retries: 10
      start_period: 30s
    environment:
      DATABASE_URL: ecto://postgres:postgres@egregoros_db:5432/egregoros_prod
      SECRET_KEY_BASE: "fedbox_secret_key_base_egregoros"
      PHX_HOST: egregoros.test
      PHX_SCHEME: http
      PHX_PORT: 80
      EGREGOROS_ALLOW_PRIVATE_FEDERATION: "true"
      EGREGOROS_FEDERATION_WEBFINGER_SCHEME: http
      EGREGOROS_UPLOADS_DIR: /data/uploads
    volumes:
      - egregoros_fed_uploads:/data/uploads
    expose:
      - "4000"
    command: >
      sh -lc 'bin/egregoros eval "Egregoros.Release.migrate()" && exec bin/egregoros start'
    networks:
      - federation

  pleroma_db:
    image: postgres:16
    restart: unless-stopped
    environment:
      POSTGRES_USER: pleroma
      POSTGRES_PASSWORD: pleroma
      POSTGRES_DB: pleroma
    volumes:
      - pleroma_fed_db:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U pleroma"]
      interval: 10s
      timeout: 5s
      retries: 10
    networks:
      - federation

  pleroma_web:
    build:
      context: ${PLEROMA_CONTEXT:-../../../pleroma}
    image: pleroma-fedbox
    restart: unless-stopped
    depends_on:
      pleroma_db:
        condition: service_healthy
    environment:
      DOMAIN: pleroma.test
      INSTANCE_NAME: Pleroma (fedbox)
      ADMIN_EMAIL: admin@pleroma.test
      NOTIFY_EMAIL: notify@pleroma.test
      DB_HOST: pleroma_db
      DB_PORT: 5432
      DB_NAME: pleroma
      DB_USER: pleroma
      DB_PASS: pleroma
    volumes:
      - pleroma_fed_data:/var/lib/pleroma
      - ./pleroma/config.exs:/var/lib/pleroma/config.exs:ro
    expose:
      - "4000"
    healthcheck:
      test:
        ["CMD-SHELL", "wget -qO- http://127.0.0.1:4000/api/v1/instance >/dev/null || exit 1"]
      interval: 15s
      timeout: 10s
      retries: 10
      start_period: 30s
    networks:
      - federation

  pleroma_seed:
    image: pleroma-fedbox
    restart: "no"
    depends_on:
      pleroma_web:
        condition: service_healthy
    environment:
      DOMAIN: pleroma.test
      DB_HOST: pleroma_db
      DB_PORT: 5432
      DB_NAME: pleroma
      DB_USER: pleroma
      DB_PASS: pleroma
    volumes:
      - pleroma_fed_data:/var/lib/pleroma
      - ./pleroma/config.exs:/var/lib/pleroma/config.exs:ro
    command:
      - sh
      - -lc
      - /opt/pleroma/bin/pleroma_ctl user new bob bob@pleroma.test --password password --admin --assume-yes || true
    networks:
      - federation

  mastodon_db:
    image: postgres:16
    restart: unless-stopped
    environment:
      POSTGRES_USER: mastodon
      POSTGRES_PASSWORD: mastodon
      POSTGRES_DB: mastodon
    volumes:
      - mastodon_fed_db:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U mastodon"]
      interval: 10s
      timeout: 5s
      retries: 10
    networks:
      - federation

  mastodon_redis:
    image: redis:7-alpine
    restart: unless-stopped
    volumes:
      - mastodon_fed_redis:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 10
    networks:
      - federation

  mastodon_init:
    image: ${MASTODON_IMAGE:-ghcr.io/mastodon/mastodon:v4.5.3}
    restart: "no"
    depends_on:
      mastodon_db:
        condition: service_healthy
      mastodon_redis:
        condition: service_healthy
    environment: &mastodon_env
      RAILS_ENV: development
      NODE_ENV: production
      PORT: 3000
      LOCAL_DOMAIN: mastodon.test
      WEB_DOMAIN: mastodon.test
      REDIS_HOST: mastodon_redis
      REDIS_PORT: 6379
      DB_HOST: mastodon_db
      DB_PORT: 5432
      DB_NAME: mastodon
      DB_USER: mastodon
      DB_PASS: mastodon
      SECRET_KEY_BASE: "fca7fa5fe8ca9b7bbcaa442535b973e772e6392f46aab7fb3ec227ef5eb8d8c6605b921f7af4c2cc41f19a20633334e11c6012d6de958d0b14c4c2aa24a294ab"
      ACTIVE_RECORD_ENCRYPTION_PRIMARY_KEY: "ZVdBBUYdAX9il2dZ3mwVRv1h7bDnRlH9oybCdHautQUNIhSBoV7wdpKm+ByScMaeEChmrmxIhIMBujlnikHUqA=="
      ACTIVE_RECORD_ENCRYPTION_DETERMINISTIC_KEY: "82yPOOdC5iAbaCU7ck0hsWP1kJqMH8g7v/vtzS+AlWBFsVvcuzGYBg888Oa+vBkhXY8Xr1jE03WbSwVwHDR3Aw=="
      ACTIVE_RECORD_ENCRYPTION_KEY_DERIVATION_SALT: "6UZS4kC1TsljaOCidkEGQHqnIIcN0zqayJu2ANKYAHsLtKnjZOvcEvhDehRaf0LfQNHim/9asXmILvVukOuw0w=="
    command:
      - sh
      - -lc
      - bundle exec rails db:prepare && bin/tootctl accounts create carol --email carol@mastodon.test --confirmed --approve --role Owner || true
    volumes:
      - mastodon_fed_system:/mastodon/public/system
    networks:
      - federation

  mastodon_web:
    image: ${MASTODON_IMAGE:-ghcr.io/mastodon/mastodon:v4.5.3}
    restart: unless-stopped
    depends_on:
      mastodon_init:
        condition: service_completed_successfully
    environment: *mastodon_env
    command: bundle exec puma -C config/puma.rb
    expose:
      - "3000"
    volumes:
      - mastodon_fed_system:/mastodon/public/system
    healthcheck:
      test: ["CMD-SHELL", "curl -s --noproxy localhost localhost:3000/health | grep -q 'OK' || exit 1"]
      interval: 15s
      timeout: 10s
      retries: 10
      start_period: 30s
    networks:
      - federation

  mastodon_sidekiq:
    image: ${MASTODON_IMAGE:-ghcr.io/mastodon/mastodon:v4.5.3}
    restart: unless-stopped
    depends_on:
      mastodon_init:
        condition: service_completed_successfully
    environment: *mastodon_env
    command: bundle exec sidekiq
    volumes:
      - mastodon_fed_system:/mastodon/public/system
    networks:
      - federation

  fedtest:
    profiles: ["fedtest"]
    image: egregoros-fedbox
    depends_on:
      egregoros_web:
        condition: service_healthy
      pleroma_web:
        condition: service_healthy
      mastodon_web:
        condition: service_healthy
    environment:
      DATABASE_URL: ecto://postgres:postgres@egregoros_db:5432/egregoros_prod
      SECRET_KEY_BASE: "fedbox_secret_key_base_egregoros"
      PHX_HOST: egregoros.test
      PHX_SCHEME: http
      PHX_PORT: 80
      EGREGOROS_ALLOW_PRIVATE_FEDERATION: "true"
      EGREGOROS_FEDERATION_WEBFINGER_SCHEME: http
    volumes:
      - ./test_runner:/app/fedtest:ro
    command:
      - sh
      - -lc
      - bin/egregoros eval "Code.require_file('/app/fedtest/federation_box_test.exs'); FederationBoxTest.run()"
    networks:
      - federation

volumes:
  egregoros_fed_db:
  egregoros_fed_uploads:
  pleroma_fed_db:
  pleroma_fed_data:
  mastodon_fed_db:
  mastodon_fed_redis:
  mastodon_fed_system:

networks:
  federation:
