[tools]
elixir = "1.19.0-otp-28"
erlang = "28.3"

[env]
_.file = ".env"

[tasks."fed:up"]
description = "Start federation-in-a-box (Egregoros + Pleroma + Mastodon)"
run = "docker compose -f docker/federation/compose.yml up -d --build"

[tasks."fed:test"]
description = "Run federation-in-a-box smoke test (outgoing follow + accept)"
run = '''
set -eu

compose() {
  docker compose -f docker/federation/compose.yml "$@"
}

cleanup() {
  compose down -v --remove-orphans || true
}

trap cleanup EXIT

compose down -v --remove-orphans || true
compose --profile fedtest run --rm --build fedtest
'''

[tasks."fed:logs"]
description = "Tail federation-in-a-box logs"
run = "docker compose -f docker/federation/compose.yml logs -f --no-color"

[tasks."fed:down"]
description = "Stop federation-in-a-box and delete volumes"
run = "docker compose -f docker/federation/compose.yml down -v --remove-orphans"
